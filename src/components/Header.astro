---
import { supabase } from "../lib/supabase";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;
let isAuthenticated = false;

if (accessToken && refreshToken) {
  const response = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (response.error) {
    cookies.delete("sb-access-token", { path: "/" });
    cookies.delete("sb-refresh-token", { path: "/" });
  } else {
    isAuthenticated = !!response.data;
  }
}

export { isAuthenticated };
---

<header class="px-3 py-10 sm:px-6">
  <div class="flex items-center justify-between max-w-3xl mx-auto lg:max-w-6xl">
    <div>
      <a
        href="/"
        aria-label="Flavia's Sweets"
        title="Flavia's Sweets"
        class="inline-flex items-center"
      >
        <span class="ml-2 text-3xl font-bold tracking-wide hover:text-pink-400">
          Flavia's Sweets
        </span>
      </a>
    </div>
    <div class="flex items-center space-x-4">
      <ul class="flex space-x-4 text-lg font-bold">
        <a href="/" class="hover:text-pink-400">
          <li>Home</li>
        </a>
        <a href="/dashboard" class="hover:text-pink-400">
          <li>Dashboard</li>
        </a>
        <a href="/crud/clients" class="hover:text-pink-400">
          <li>Clients</li>
        </a>
        <a href="/crud/orders" class="hover:text-pink-400">
          <li>Orders</li>
        </a>
        {
          isAuthenticated ? (
            <form action="/api/auth/signout" class="mb-6">
              <button type="submit" class="hover:text-pink-400">
                <li>Sign Out</li>
              </button>
            </form>
          ) : (
            <a href="/signin" class="hover:text-pink-400">
              <li>Sign In</li>
            </a>
          )
        }
      </ul>
    </div>
  </div>
</header>
